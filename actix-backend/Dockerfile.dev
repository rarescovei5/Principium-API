# 1. Base image with Rust toolchain
FROM rust:1.87.0-slim

# 2. Install system deps (Postgres client libs for build)
RUN apt-get update && apt-get install -y \
  libpq-dev \
  pkg-config \
  libssl-dev \
  build-essential \
  && rm -rf /var/lib/apt/lists/*

# 3. Set working dir
WORKDIR /app

# 4. Copy SQLx metadata (must be generated by `cargo sqlx prepare`) 
#    and enable offline mode so macros don't try to connect
COPY .sqlx ./.sqlx
ENV SQLX_OFFLINE=1

# 5. Copy dependency manifests and fetch deps
COPY Cargo.toml Cargo.lock ./
RUN cargo fetch

# 6. Copy source code
COPY src ./src

# 7. Install hot-reload tool
RUN cargo install cargo-watch

# 8. Expose app port
EXPOSE 8080

# 9. Dev entrypoint: recompile & rerun on code changes
CMD ["cargo", "watch", "-x", "run"]
